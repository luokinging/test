name: Aliyun Deployment

on:
  push:
    branches:
      - production
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write
  packages: write

env:
  REGION_ID: "cn-hangzhou"
  IMAGE_NAME: "webserver"

  # Application IDs (Web / Worker / Beat)
  SAE_APP_ID_WEB: "3e94a604-0dfd-450a-bb82-61c34a647e82"
  SAE_APP_ID_WORKER: "6784e748-8402-455a-b7bb-c93ea716cd6c"
  SAE_APP_ID_BEAT: "e2522dac-191b-41ea-a9da-db069cb7f25b"

  # Job IDs (Migrate / Static)
  SAE_JOB_ID_MIGRATE: "ebc48e2b-06e6-41b3-a76f-29e5642647e0"
  SAE_JOB_ID_COLLECT_STATIC: "1cd9998d-9017-49e0-ac31-0c63daf8fb86"

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Login to Docker Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ALIYUN_REGISTRY }}
          username: ${{ secrets.ALIYUN_REGISTRY_USER }}
          password: ${{ secrets.ALIYUN_REGISTRY_PWD }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and Push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.ALIYUN_REGISTRY }}/${{ secrets.ALIYUN_NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
            ${{ secrets.ALIYUN_REGISTRY }}/${{ secrets.ALIYUN_NAMESPACE }}/${{ env.IMAGE_NAME }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  db-migrate:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Aliyun CLI
        uses: ./.github/actions/setup-aliyun
        with:
          region: ${{ env.REGION_ID }}
          access-key-id: ${{ secrets.ALIYUN_AK }}
          access-key-secret: ${{ secrets.ALIYUN_SK }}

      - name: Run Migration Job
        env:
          TARGET_IMAGE: ${{ secrets.ALIYUN_REGISTRY }}/${{ secrets.ALIYUN_NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
        run: |
          chmod +x .github/scripts/sae-update-and-exec-job.sh
          .github/scripts/sae-update-and-exec-job.sh \
            "${{ env.SAE_JOB_ID_MIGRATE }}" \
            "$TARGET_IMAGE" \
            "Migration Job"

  static-collect:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Aliyun CLI
        uses: ./.github/actions/setup-aliyun
        with:
          region: ${{ env.REGION_ID }}
          access-key-id: ${{ secrets.ALIYUN_AK }}
          access-key-secret: ${{ secrets.ALIYUN_SK }}

      - name: Run Static Collection Job
        env:
          TARGET_IMAGE: ${{ secrets.ALIYUN_REGISTRY }}/${{ secrets.ALIYUN_NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
        run: |
          chmod +x .github/scripts/sae-update-and-exec-job.sh
          .github/scripts/sae-update-and-exec-job.sh \
            "${{ env.SAE_JOB_ID_COLLECT_STATIC }}" \
            "$TARGET_IMAGE" \
            "Static Collection Job"

  deploy-services:
    needs: [build-and-push, db-migrate, static-collect]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Aliyun CLI
        uses: ./.github/actions/setup-aliyun
        with:
          region: ${{ env.REGION_ID }}
          access-key-id: ${{ secrets.ALIYUN_AK }}
          access-key-secret: ${{ secrets.ALIYUN_SK }}

      - name: Deploy Web, Worker and Beat
        env:
          FULL_IMAGE_URL: ${{ secrets.ALIYUN_REGISTRY }}/${{ secrets.ALIYUN_NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
        run: |
          echo "ðŸš€ 1. Deploying Web App (Full Release)..."
          aliyun sae DeployApplication \
            --AppId ${{ env.SAE_APP_ID_WEB }} \
            --ImageUrl "$FULL_IMAGE_URL"

          echo "ðŸš€ 2. Deploying Celery Worker..."
          aliyun sae DeployApplication \
            --AppId ${{ env.SAE_APP_ID_WORKER }} \
            --ImageUrl "$FULL_IMAGE_URL"

          echo "ðŸš€ 3. Deploying Celery Beat..."
          aliyun sae DeployApplication \
            --AppId ${{ env.SAE_APP_ID_BEAT }} \
            --ImageUrl "$FULL_IMAGE_URL"
